<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>St. Jarir Cost â€” Ù†Ø³Ø®Ø© ÙˆÙŠØ¨ ÙÙ‚Ø·</title>
<style>
  :root{--bg:#0f0f12;--card:#15161a;--text:#e8eaed;--accent:#ff7a00;}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  body{margin:0;background:var(--bg);color:var(--text)}
  header{padding:12px 16px;border-bottom:1px solid #222;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  header h1{margin:0;font-size:16px}
  button{background:#22262b;color:#fff;border:1px solid #333;padding:6px 10px;border-radius:8px;cursor:pointer}
  button.primary{background:var(--accent);color:#111;border-color:transparent;font-weight:700}
  select,input{background:#0f1013;color:#fff;border:1px solid #333;border-radius:8px;padding:6px 8px;text-align:center}
  main{max-width:1200px;margin:16px auto 100px;padding:0 12px}
  .card{background:#1a1b1e;border:1px solid #2a2b2e;border-radius:12px;padding:12px;margin-bottom:16px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #2a2b2e;text-align:center}
  .mini{font-size:12px;color:#b6bcc7}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .pill{display:inline-block;background:#0f1013;border:1px solid #2a2b2e;border-radius:10px;padding:8px 10px;margin:6px 4px}
  footer{position:fixed;bottom:0;left:0;right:0;background:#111;color:#b6bcc7;border-top:1px solid #222;font-size:12px;text-align:center;padding:8px}
</style>
</head>
<body>
<header>
  <h1>Ø­Ø§Ø³Ø¨Ø© ØªÙƒÙ„ÙØ© St. Jarir</h1>
  <select id="productSelect" title="Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ø§Ù„ÙŠ"></select>
  <button id="btnNew">Ø¬Ø¯ÙŠØ¯</button>
  <button id="btnRename">Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©</button>
  <button id="btnDelete">Ø­Ø°Ù</button>
  <button id="btnSave" class="primary">Ø­ÙØ¸</button>
  <button id="btnSaveAs">Ø­ÙØ¸ Ø¨Ø§Ø³Ù…â€¦</button>
  <button id="btnPrint">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
</header>

<main>
  <!-- Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… -->
  <section class="card">
    <h2>Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… <button id="addRowBtn">+ Ù…Ø§Ø¯Ø©</button></h2>
    <div class="mini">Ø§Ù„Ø­Ø³Ø§Ø¨: (Ø³Ø¹Ø± Ø§Ù„Ø´Ø¯Ø© Ã· Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø´Ø¯Ø©) Ã— Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</div>
    <table id="materialsTbl">
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
          <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
          <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø¯Ø© (Ø±ÙŠØ§Ù„)</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø´Ø¯Ø©</th>
          <th>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</th>
          <th>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="5">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„ÙƒÙ„ ÙƒÙˆØ¨</td>
          <td id="materialsTotal">0.00</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </section>

  <!-- Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙˆØ§Ù„ØªÙˆØ²ÙŠØ¹ -->
  <section class="card">
    <h2>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© & ØªÙˆØ²ÙŠØ¹Ù‡Ø§ Ø¨ÙŠÙ† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <div class="row">
      <label>Ø¥ÙŠØ¬Ø§Ø± <input type="number" id="rent" value="5000" step="0.01"></label>
      <label>Ø±ÙˆØ§ØªØ¨ <input type="number" id="labor" value="8000" step="0.01"></label>
      <label>ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…ÙŠØ§Ù‡ <input type="number" id="utilities" value="1200" step="0.01"></label>
      <label>Ø£Ø®Ø±Ù‰ <input type="number" id="other" value="800" step="0.01"></label>
    </div>
    <div class="row" style="margin-top:8px">
      <label>Ù…Ø¨ÙŠØ¹Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø´Ù‡Ø±ÙŠÙ‹Ø§ <input type="number" id="expectedSales" value="2000" step="1" min="0"></label>
    </div>
    <div>
      <span class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: <b id="fixedTotal">0.00</b></span>
      <span class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: <b id="totalExpectedAll">0</b></span>
      <span class="pill">Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: <b id="fixedShareForProduct">0.00</b></span>
      <span class="pill">Ù†ØµÙŠØ¨ Ø§Ù„ÙƒÙˆØ¨ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: <b id="fixedPerCup">0.00</b></span>
    </div>
  </section>

  <!-- Ø§Ù„ØªØ³Ø¹ÙŠØ± -->
  <section class="card">
    <h2>Ø§Ù„ØªØ³Ø¹ÙŠØ± ÙˆØ§Ù„Ø±Ø¨Ø­ÙŠØ©</h2>
    <div class="row">
      <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©) <input type="number" id="sellPriceManual" value="30" step="0.01"></label>
      <label>Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ % <input type="number" id="targetMargin" value="40" step="0.1"></label>
      <label>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© % <input type="number" id="vatRate" value="15" step="0.1"></label>
    </div>
    <div>
      <span class="pill">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„ÙƒÙˆØ¨: <b id="realCost">0.00</b></span>
      <span class="pill">Ø§Ù„Ø±Ø¨Ø­ (ÙŠØ¯ÙˆÙŠ): <b id="profitManual">0.00</b></span>
      <span class="pill">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­: <b id="marginManual">0%</b></span>
      <span class="pill">Ø³Ø¹Ø± Ù…Ù‚ØªØ±Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: <b id="suggestedPrice">0.00</b></span>
      <span class="pill">Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: <b id="suggestedAfterVat">0.00</b></span>
    </div>
  </section>

  <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ -->
  <section class="card">
    <h2>ğŸ“Š ØªÙ‚Ø±ÙŠØ± ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ù„ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <div class="mini">ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©.</div>
    <table>
      <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©</th><th>Ù†ØµÙŠØ¨ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</th><th>Ø§Ù„Ù†Ø³Ø¨Ø© %</th></tr></thead>
      <tbody id="summaryBody"></tbody>
      <tfoot><tr><td><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b></td><td id="sumExp">0</td><td id="sumShare">0.00</td><td>100%</td></tr></tfoot>
    </table>
  </section>
</main>

<footer>ğŸ’¾ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ (LocalStorage). (Ù†Ø³Ø®Ø© Ù…ØªØµÙØ­ ÙÙ‚Ø·)</footer>

<script>
const $ = (s)=>document.querySelector(s);
const tblBody = $('#materialsTbl tbody');

/* Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: 10 Ù…ÙˆØ§Ø¯ */
const defaultMaterials = Array.from({length:10}, (_,i)=>({
  name:`Ù…Ø§Ø¯Ø© ${i+1}`, unit:'piece', packPrice:0, packCount:1, usedCount:0
}));
const defaultState = {
  materials: JSON.parse(JSON.stringify(defaultMaterials)),
  rent:5000, labor:8000, utilities:1200, other:800,
  expectedSales:2000,
  sellPriceManual:30, targetMargin:40, vatRate:15
};

/* ØªØ®Ø²ÙŠÙ† Ù…Ù†ØªØ¬Ø§Øª */
const PRODUCTS_KEY='stjarir_products_v1'; const CURRENT_ID_KEY='stjarir_current_id_v1';
function uid(){return 'p_'+Math.random().toString(36).slice(2,9)}
function loadProducts(){ try{ return JSON.parse(localStorage.getItem(PRODUCTS_KEY)||'[]'); }catch{ return []; } }
function saveProducts(list){ localStorage.setItem(PRODUCTS_KEY, JSON.stringify(list)); }
function getCurrentId(){ return localStorage.getItem(CURRENT_ID_KEY)||''; }
function setCurrentId(id){ localStorage.setItem(CURRENT_ID_KEY, id); }
function getCurrentProduct(){ const id = getCurrentId(); return loadProducts().find(p=>p.id===id); }

/* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
function renderProductSelect(){
  const sel = $('#productSelect');
  let list = loadProducts();
  if(!list.length){
    const id = uid();
    list = [{id, name:'Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯', state: JSON.parse(JSON.stringify(defaultState))}];
    saveProducts(list); setCurrentId(id);
  }
  sel.innerHTML='';
  list.forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p.id; opt.textContent = p.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
    if(p.id===getCurrentId()) opt.selected = true;
    sel.appendChild(opt);
  });
}
function setCurrentProductState(state){
  const id = getCurrentId();
  const list = loadProducts().map(p=> p.id===id ? ({...p, state}) : p);
  saveProducts(list);
}

/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ */
function unitLabel(u){ return u==='g'?'Ø¬Ù…':(u==='ml'?'Ù…Ù„':'Ø­Ø¨Ø©'); }
function addRow(item){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="name" value="${item.name}"></td>
    <td>
      <select class="unitSel">
        <option value="piece"${item.unit==='piece'?' selected':''}>Ø­Ø¨Ø©</option>
        <option value="g"${item.unit==='g'?' selected':''}>Ø¬Ù…</option>
        <option value="ml"${item.unit==='ml'?' selected':''}>Ù…Ù„</option>
      </select>
    </td>
    <td><input type="number" class="packPrice" value="${item.packPrice}" step="0.01"></td>
    <td><input type="number" class="packCount" value="${item.packCount}" step="0.01"></td>
    <td><input type="number" class="usedCount" value="${item.usedCount}" step="0.01"></td>
    <td class="cost">0.00</td>
    <td><button class="del">Ø­Ø°Ù</button> <button class="dup">Ù†Ø³Ø®</button></td>
  `;
  tr.querySelector('.del').onclick = ()=>{ tr.remove(); recalc(); };
  tr.querySelector('.dup').onclick = ()=>{
    addRow({
      name: tr.querySelector('.name').value,
      unit: tr.querySelector('.unitSel').value,
      packPrice: +tr.querySelector('.packPrice').value||0,
      packCount: +tr.querySelector('.packCount').value||1,
      usedCount: +tr.querySelector('.usedCount').value||0
    });
    recalc();
  };
  tr.querySelectorAll('input, select').forEach(el=> el.addEventListener('input', recalc));
  tblBody.appendChild(tr);
}

/* Ø¬Ù…Ø¹/ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ø§Ù„Ø© */
function collectState(){
  const materials = [...tblBody.querySelectorAll('tr')].map(tr=>({
    name: tr.querySelector('.name').value||'',
    unit: tr.querySelector('.unitSel').value,
    packPrice: parseFloat(tr.querySelector('.packPrice').value)||0,
    packCount: Math.max(0.000001, parseFloat(tr.querySelector('.packCount').value)||0),
    usedCount: Math.max(0, parseFloat(tr.querySelector('.usedCount').value)||0)
  }));
  return {
    materials,
    rent: parseFloat($('#rent').value)||0,
    labor: parseFloat($('#labor').value)||0,
    utilities: parseFloat($('#utilities').value)||0,
    other: parseFloat($('#other').value)||0,
    expectedSales: Math.max(0, parseInt($('#expectedSales').value||'0')),
    sellPriceManual: parseFloat($('#sellPriceManual').value)||0,
    targetMargin: parseFloat($('#targetMargin').value)||0,
    vatRate: parseFloat($('#vatRate').value)||0
  };
}

/* âœ… ØªØ¹Ø¨Ø¦Ø© Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­: Ù„Ùˆ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙØ§Ø¶ÙŠØ© Ù†Ø¹Ø¨ÙŠ 10 ØµÙÙˆÙ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ */
function populate(state){
  if (!state.materials || state.materials.length === 0) {
    state.materials = JSON.parse(JSON.stringify(defaultMaterials));
    setCurrentProductState(state); // Ù†Ø­ÙØ¸ Ø§Ù„ØªØµØ­ÙŠØ­ ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ø§Ù„ÙŠ
  }
  tblBody.innerHTML='';
  (state.materials||[]).forEach(addRow);
  $('#rent').value = state.rent || 0;
  $('#labor').value = state.labor || 0;
  $('#utilities').value = state.utilities || 0;
  $('#other').value = state.other || 0;
  $('#expectedSales').value = state.expectedSales ?? 0;
  $('#sellPriceManual').value = state.sellPriceManual ?? 0;
  $('#targetMargin').value = state.targetMargin ?? 0;
  $('#vatRate').value = state.vatRate ?? 0;
  recalc();
}

/* Ø­Ø³Ø§Ø¨Ø§Øª */
function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }
function recalc(){
  const st = collectState();

  // ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯
  let materialsTotal = 0;
  [...tblBody.querySelectorAll('tr')].forEach(tr=>{
    const p = parseFloat(tr.querySelector('.packPrice').value)||0;
    const c = Math.max(0.000001, parseFloat(tr.querySelector('.packCount').value)||0);
    const u = Math.max(0, parseFloat(tr.querySelector('.usedCount').value)||0);
    const cost = (p/c)*u;
    tr.querySelector('.cost').textContent = fmt(cost);
    materialsTotal += cost;
  });
  $('#materialsTotal').textContent = fmt(materialsTotal);

  // Ù…ØµØ§Ø±ÙŠÙ ÙˆØ§Ù„ØªÙˆØ²ÙŠØ¹
  const fixedTotal = (st.rent||0)+(st.labor||0)+(st.utilities||0)+(st.other||0);
  $('#fixedTotal').textContent = fmt(fixedTotal);
  const all = loadProducts();
  const totalExpectedAll = all.reduce((s,p)=> s + Math.max(0, parseInt(p.state?.expectedSales||0)), 0);
  $('#totalExpectedAll').textContent = totalExpectedAll;

  const share = (totalExpectedAll>0) ? fixedTotal * ((st.expectedSales||0)/totalExpectedAll) : fixedTotal;
  $('#fixedShareForProduct').textContent = fmt(share);
  const fixedPerCup = (totalExpectedAll>0 && st.expectedSales>0) ? share / st.expectedSales : (fixedTotal / Math.max(1, st.expectedSales||1));
  $('#fixedPerCup').textContent = fmt(fixedPerCup);

  // Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„ÙƒÙˆØ¨
  const realCost = materialsTotal + fixedPerCup;
  $('#realCost').textContent = fmt(realCost);

  // Ø§Ù„ØªØ³Ø¹ÙŠØ±
  const profitManual = (st.sellPriceManual||0) - realCost;
  $('#profitManual').textContent = fmt(profitManual);
  const marginManual = (st.sellPriceManual>0) ? (profitManual / st.sellPriceManual * 100) : 0;
  $('#marginManual').textContent = fmt(marginManual) + '%';
  const suggestedPrice = (1 - (st.targetMargin||0)/100) <= 0 ? 0 : realCost / (1 - (st.targetMargin||0)/100);
  $('#suggestedPrice').textContent = fmt(suggestedPrice);
  $('#suggestedAfterVat').textContent = fmt(suggestedPrice * (1 + (st.vatRate||0)/100));

  // Ø­ÙØ¸ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ø§Ù„ÙŠ
  const id = getCurrentId();
  saveProducts(loadProducts().map(p=> p.id===id ? ({...p, state: st}) : p));

  // Ø­Ø¯Ø« ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ
  renderSummary();
}

/* ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ */
function renderSummary(){
  const body = $('#summaryBody');
  body.innerHTML='';
  const list = loadProducts();
  const cur = getCurrentProduct();
  if(!cur) return;

  const fixed = (cur.state.rent||0)+(cur.state.labor||0)+(cur.state.utilities||0)+(cur.state.other||0);
  const totalExpectedAll = list.reduce((s,p)=> s + Math.max(0, parseInt(p.state?.expectedSales||0)), 0);

  let sumShare = 0;
  list.forEach(p=>{
    // Ø¥ØµÙ„Ø§Ø­ Ù‚Ø¯ÙŠÙ…: Ø§Ù„Ù…Ù†ØªØ¬ Ù‚Ø¯ ÙŠÙØªÙ‚Ø¯ materials -> Ù†Ø¶Ù…Ù† ØªØ¹Ø¨Ø¦ØªÙ‡ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ù†Ø¯ ÙØªØ­Ù‡
    if (!p.state.materials || p.state.materials.length===0){
      p.state.materials = JSON.parse(JSON.stringify(defaultMaterials));
      saveProducts(list);
    }
    const exp = Math.max(0, parseInt(p.state?.expectedSales||0));
    const share = (totalExpectedAll>0) ? fixed * (exp / totalExpectedAll) : 0;
    const pct = (fixed>0) ? (share / fixed * 100) : 0;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.name||'Ù…Ù†ØªØ¬'}</td><td>${exp}</td><td>${fmt(share)}</td><td>${fmt(pct)}%</td>`;
    body.appendChild(tr);
    sumShare += share;
  });
  $('#sumExp').textContent = totalExpectedAll;
  $('#sumShare').textContent = fmt(sumShare);
}

/* Ø£Ø²Ø±Ø§Ø± ÙˆØ¥Ø¬Ø±Ø§Ø¡Ø§Øª */
$('#productSelect').addEventListener('change', ()=>{ setCurrentId($('#productSelect').value); const p=getCurrentProduct(); if(p) populate(p.state); });
$('#btnNew').addEventListener('click', ()=>{
  const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŸ','Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯'); if(!name) return;
  const id = uid();
  const list = loadProducts(); list.push({id, name, state: JSON.parse(JSON.stringify(defaultState))});
  saveProducts(list); setCurrentId(id); renderProductSelect(); populate(defaultState);
});
$('#btnRename').addEventListener('click', ()=>{
  const p = getCurrentProduct(); if(!p) return;
  const name = prompt('Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯:', p.name); if(!name) return;
  saveProducts(loadProducts().map(x=> x.id===p.id ? ({...x, name}) : x)); renderProductSelect();
});
$('#btnDelete').addEventListener('click', ()=>{
  const p = getCurrentProduct(); if(!p) return;
  if(!confirm(`Ø­Ø°Ù "${p.name}"ØŸ`)) return;
  let list = loadProducts().filter(x=> x.id!==p.id);
  if(!list.length){
    const id = uid(); list=[{id, name:'Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯', state: JSON.parse(JSON.stringify(defaultState))}]; setCurrentId(id);
  }else{ setCurrentId(list[0].id); }
  saveProducts(list); renderProductSelect(); populate(getCurrentProduct().state);
});
$('#btnSave').addEventListener('click', ()=>{ setCurrentProductState(collectState()); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); });
$('#btnSaveAs').addEventListener('click', ()=>{
  const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù†Ø³Ø®Ø©ØŸ','Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø©'); if(!name) return;
  const id = uid(); const st = collectState(); const list = loadProducts();
  list.push({id, name, state: st}); saveProducts(list); setCurrentId(id); renderProductSelect(); alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø©');
});
$('#btnPrint').addEventListener('click', ()=>{ window.print(); });

$('#addRowBtn').addEventListener('click', ()=>{ addRow({name:'',unit:'piece',packPrice:0,packCount:1,usedCount:0}); recalc(); });
document.addEventListener('input', (e)=>{ if(e.target.matches('input,select')) recalc(); });

/* ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ */
function init(){
  renderProductSelect();
  const p = getCurrentProduct();
  populate(p ? p.state : JSON.parse(JSON.stringify(defaultState)));
}
init();
</script>
</body>
</html>
