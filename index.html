<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>St. Jarir Cost â€” ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ + ØªÙ‚Ø±ÙŠØ± + Ø·Ø¨Ø§Ø¹Ø©</title>
<style>
  :root{--bg:#0f0f12;--card:#15161a;--muted:#8b909a;--text:#e8eaed;--accent:#ff7a00;--ok:#25c26e;--bad:#ff4d4f;}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  body{margin:0;background:var(--bg);color:var(--text);}
  header{padding:12px 16px;border-bottom:1px solid #222;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  header h1{margin:0;font-size:16px;white-space:nowrap}
  button{background:#22262b;color:var(--text);border:1px solid #2d3136;padding:6px 10px;border-radius:10px;cursor:pointer}
  button.primary{background:var(--accent);border-color:transparent;color:#111;font-weight:700}
  select,input[type="text"],input[type="number"]{background:#0f1013;color:var(--text);border:1px solid #2d3136;border-radius:10px;padding:8px 10px;text-align:center}
  main{max-width:1200px;margin:16px auto 100px;padding:0 12px}
  .grid{display:grid;gap:16px}
  @media(min-width:1100px){.grid{grid-template-columns:1.2fr .8fr}}
  .card{background:var(--card);border:1px solid #202227;border-radius:16px;padding:16px}
  .card h2{margin:0 0 12px;font-size:16px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #24262c;text-align:center}
  th{font-weight:700;color:#cfd3da}
  td .row-actions{display:flex;justify-content:center;gap:6px;flex-wrap:wrap}
  .mini{font-size:12px;color:#cfd3da}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .pill{background:#0e0f12;border:1px solid #2a2e34;padding:10px 12px;border-radius:10px;min-width:150px;text-align:center}
  .pill b{display:block;font-size:18px;margin-top:4px}
  .success{background:#122a18;border-color:#1e3a26;color:#b8f0c9}
  .danger{background:#2a1215;border-color:#3a1a1f;color:#ffb3b5}
  .sep{width:1px;height:28px;background:#2a2d33;display:inline-block;margin:0 6px;border-radius:2px}
  .nowrap{white-space:nowrap}
  td .unit-suffix{font-size:12px;color:#cfd3da;display:block;margin-top:4px}
  .actions-right{margin-inline-start:auto;display:flex;gap:8px;flex-wrap:wrap}
  /* ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ */
  #summary{margin-top:16px}
  #summary table tfoot td{font-weight:700}
  /* Ø·Ø¨Ø§Ø¹Ø©: Ù†Ø®ÙÙŠ ÙƒÙ„ Ø´ÙŠØ¡ Ø¥Ù„Ø§ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙŠ Ù†ÙØªØ­Ù‡Ø§ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ù…Ù†ÙØµÙ„ */
  @media print { body{background:#fff} }
</style>
</head>
<body>
  <header>
    <h1>Ø­Ø§Ø³Ø¨Ø© ØªÙƒÙ„ÙØ© St. Jarir</h1>

    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <select id="productSelect" title="Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ø§Ù„ÙŠ"></select>
    <button id="btnNew">Ø¬Ø¯ÙŠØ¯</button>
    <button id="btnRename">Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©</button>
    <button id="btnDelete">Ø­Ø°Ù</button>
    <span class="sep"></span>
    <button id="btnSave" class="primary">Ø­ÙØ¸</button>
    <button id="btnSaveAs">Ø­ÙØ¸ Ø¨Ø§Ø³Ù…â€¦</button>

    <div class="actions-right">
      <button id="btnPrint">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù†ØªØ¬</button>
      <button id="btnSummary">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ</button>
      <button id="resetBtn">Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <h2>Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… <button id="addRowBtn">+ Ù…Ø§Ø¯Ø©</button></h2>
      <table id="materialsTbl">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø®Ø§Ù…</th>
            <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th class="nowrap">Ø³Ø¹Ø± Ø§Ù„Ø´Ø¯Ø© (Ø±ÙŠØ§Ù„)</th>
            <th class="nowrap">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø´Ø¯Ø©</th>
            <th class="nowrap">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</th>
            <th>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙØ¹Ù„ÙŠØ©</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="5" class="mini">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„ÙƒÙ„ ÙƒÙˆØ¨</td>
            <td id="materialsTotal">0.00</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
      <div class="mini">Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: (Ø³Ø¹Ø± Ø§Ù„Ø´Ø¯Ø© Ã· Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª) Ã— Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© â€” Ø§Ù„ÙˆØ­Ø¯Ø© (Ø­Ø¨Ø©/Ø¬Ù…/Ù…Ù„) ØªÙØ·Ø¨Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…ØªÙŠÙ†.</div>
    </section>

    <section class="card">
      <h2>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© & Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¨ÙŠÙ† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>

      <!-- Ù…ØµØ§Ø±ÙŠÙ Ø«Ø§Ø¨ØªØ© Ø¹Ø§Ù…Ø© (ØªØ¤Ø®Ø° ÙƒÙ…Ø±Ø¬Ø¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª) -->
      <div class="kpi">
        <div><label class="mini">Ø¥ÙŠØ¬Ø§Ø±</label><input type="number" id="rent" value="5000" min="0" step="0.01"></div>
        <div><label class="mini">Ø±ÙˆØ§ØªØ¨</label><input type="number" id="labor" value="8000" min="0" step="0.01"></div>
        <div><label class="mini">ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…ÙŠØ§Ù‡</label><input type="number" id="utilities" value="1200" min="0" step="0.01"></div>
        <div><label class="mini">Ù…ØµØ§Ø±ÙŠÙ Ø£Ø®Ø±Ù‰</label><input type="number" id="other" value="800" min="0" step="0.01"></div>
      </div>

      <!-- Ù…Ø¨ÙŠØ¹Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ -->
      <div class="kpi" style="margin-top:12px">
        <div><label class="mini">Ù…Ø¨ÙŠØ¹Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© Ø´Ù‡Ø±ÙŠÙ‹Ø§</label><input type="number" id="expectedSales" value="2000" min="0" step="1"></div>
        <div><label class="mini">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¥Ù†ØªØ§Ø¬ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø´Ù‡Ø±ÙŠÙ‹Ø§</label><input type="number" id="cupsMonthly" value="2000" min="1" step="1"></div>
      </div>

      <!-- Ù…Ø¤Ø´Ø±Ø§Øª ØªÙˆØ²ÙŠØ¹ -->
      <div class="kpi" style="margin-top:12px">
        <div class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©<b id="fixedTotal">0.00</b></div>
        <div class="pill">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª<b id="totalExpectedAll">0</b></div>
        <div class="pill">Ù†ØµÙŠØ¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ<b id="fixedShareForProduct">0.00</b></div>
        <div class="pill">Ù†ØµÙŠØ¨ Ø§Ù„ÙƒÙˆØ¨ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ<b id="fixedPerCup">0.00</b></div>
      </div>
    </section>

    <section class="card">
      <h2>Ø§Ù„ØªØ³Ø¹ÙŠØ± ÙˆØ§Ù„Ø±Ø¨Ø­ÙŠØ© Ù„Ù„ÙƒÙˆØ¨</h2>
      <div class="kpi">
        <div><label class="mini">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (ÙŠØ¯ÙˆÙŠ) â€“ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</label><input type="number" id="sellPriceManual" value="30" min="0" step="0.01"></div>
        <div><label class="mini">Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© %</label><input type="number" id="targetMargin" value="40" min="0" max="95" step="0.1"></div>
        <div><label class="mini">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© %</label><input type="number" id="vatRate" value="15" min="0" max="100" step="0.1"></div>
      </div>
      <div class="kpi" style="margin-top:12px">
        <div class="pill">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„ÙƒÙˆØ¨<b id="realCost">0.00</b></div>
        <div class="pill" id="pillMargin"><span>Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ % (ÙŠØ¯ÙˆÙŠ)</span><b id="marginManual">0%</b></div>
        <div class="pill">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (ÙŠØ¯ÙˆÙŠ) Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©<b id="profitManual">0.00</b></div>
      </div>
      <div class="kpi" style="margin-top:12px">
        <div class="pill">Ø³Ø¹Ø± Ù…Ù‚ØªØ±Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©<b id="suggestedPrice">0.00</b></div>
        <div class="pill">Ø¶Ø±ÙŠØ¨Ø© Ù„ÙƒÙ„ ÙƒÙˆØ¨<b id="vatPerCup">0.00</b></div>
        <div class="pill">Ø³Ø¹Ø± Ù…Ù‚ØªØ±Ø­ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©<b id="suggestedAfterVat">0.00</b></div>
      </div>
    </section>

    <section id="summary" class="card">
      <h2>ğŸ“Š ØªÙ‚Ø±ÙŠØ± ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ù„ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
      <div class="mini">ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ ÙˆÙŠÙÙˆØ²Ù‘Ø¹Ù‡Ø§ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ù…Ø¨ÙŠØ¹Ø§ØªÙ‡Ø§ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©.</div>
      <div style="margin:10px 0">
        <button id="btnRefreshSummary">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©</th>
            <th>Ù†ØµÙŠØ¨ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ø±ÙŠØ§Ù„)</th>
            <th>Ø§Ù„Ù†Ø³Ø¨Ø© %</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
        <tfoot>
          <tr>
            <td><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b></td>
            <td id="sumExp">0</td>
            <td id="sumShare">0.00</td>
            <td>100%</td>
          </tr>
        </tfoot>
      </table>
    </section>
  </main>

  <footer style="position:fixed;bottom:0;left:0;right:0;background:rgba(15,15,18,.9);border-top:1px solid #222;padding:8px 12px;text-align:center">
    <span class="mini">ğŸ’¾ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ (LocalStorage).</span>
  </footer>

<script>
const $ = (s)=>document.querySelector(s);
const tblBody = $('#materialsTbl tbody');

/* ===== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ===== */
const defaultMaterials = Array.from({length:10}, (_,i)=>({
  name:`Ù…Ø§Ø¯Ø© ${i+1}`, unit:'piece', packPrice:0, packCount:1, usedCount:0
}));
const defaultState = {
  materials: JSON.parse(JSON.stringify(defaultMaterials)),
  rent:5000, labor:8000, utilities:1200, other:800,
  expectedSales: 2000,
  cupsMonthly: 2000,
  sellPriceManual:30, targetMargin:40, vatRate:15,
  batchQty:50, batchPriceMode:'manual'
};

/* ===== ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ===== */
const PRODUCTS_KEY = 'stjarir_products_v1';
const CURRENT_ID_KEY = 'stjarir_current_id_v1';
function uid(){ return 'p_'+Math.random().toString(36).slice(2,9); }
function loadProducts(){ try{ return JSON.parse(localStorage.getItem(PRODUCTS_KEY)||'[]'); }catch{ return []; } }
function saveProducts(list){ localStorage.setItem(PRODUCTS_KEY, JSON.stringify(list)); }
function getCurrentId(){ return localStorage.getItem(CURRENT_ID_KEY)||''; }
function setCurrentId(id){ localStorage.setItem(CURRENT_ID_KEY, id); }

/* ===== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ===== */
function renderProductSelect(){
  const sel = $('#productSelect');
  const products = loadProducts();
  let currentId = getCurrentId();

  if(products.length===0){
    const id = uid();
    const prod = {id, name:'Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯', state: JSON.parse(JSON.stringify(defaultState))};
    saveProducts([prod]); setCurrentId(id); currentId = id;
  }

  sel.innerHTML = '';
  loadProducts().forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p.id; opt.textContent = p.name;
    if(p.id===currentId) opt.selected = true;
    sel.appendChild(opt);
  });
}
function getCurrentProduct(){ const id = getCurrentId(); return loadProducts().find(p=>p.id===id); }
function setCurrentProductState(state){
  const id = getCurrentId();
  const list = loadProducts().map(p=> p.id===id ? ({...p, state}) : p);
  saveProducts(list);
}

/* ===== Ø£Ø¯ÙˆØ§Øª ===== */
function num(sel){ return parseFloat($(sel).value)||0; }
function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }
function unitLabel(u){ return u==='g' ? 'Ø¬Ù…' : (u==='ml' ? 'Ù…Ù„' : 'Ø­Ø¨Ø©'); }

/* ===== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ===== */
function makeRow(item={name:'',unit:'piece',packPrice:0,packCount:1,usedCount:0}){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="name" value="${item.name}"></td>
    <td>
      <select class="unitSel">
        <option value="piece"${item.unit==='piece'?' selected':''}>Ø­Ø¨Ø©</option>
        <option value="g"${item.unit==='g'?' selected':''}>Ø¬Ù…</option>
        <option value="ml"${item.unit==='ml'?' selected':''}>Ù…Ù„</option>
      </select>
    </td>
    <td><input type="number" class="packPrice" value="${item.packPrice}" min="0" step="0.01"></td>
    <td>
      <input type="number" class="packCount" value="${item.packCount}" min="0.000001" step="0.01">
      <span class="unit-suffix">${unitLabel(item.unit)}</span>
    </td>
    <td>
      <input type="number" class="usedCount" value="${item.usedCount}" min="0" step="0.01">
      <span class="unit-suffix">${unitLabel(item.unit)}</span>
    </td>
    <td class="cost">0.00</td>
    <td class="row-actions"><button class="del">Ø­Ø°Ù</button><button class="dup">Ù†Ø³Ø®</button></td>
  `;
  const sel = tr.querySelector('.unitSel');
  sel.addEventListener('change', ()=>{
    tr.querySelectorAll('.unit-suffix').forEach(s=>s.textContent = unitLabel(sel.value));
    recalc();
  });
  tr.querySelectorAll('input').forEach(i=>i.addEventListener('input', recalc));
  tr.querySelector('.del').addEventListener('click', ()=>{ tr.remove(); recalc(); });
  tr.querySelector('.dup').addEventListener('click', ()=>{
    addRow({
      name: tr.querySelector('.name').value,
      unit: tr.querySelector('.unitSel').value,
      packPrice: parseFloat(tr.querySelector('.packPrice').value)||0,
      packCount: Math.max(0.000001, parseFloat(tr.querySelector('.packCount').value)||0),
      usedCount: Math.max(0, parseFloat(tr.querySelector('.usedCount').value)||0),
    });
    recalc();
  });
  return tr;
}
function addRow(item){ tblBody.appendChild(makeRow(item)); }

/* ===== ØªØ¬Ù…ÙŠØ¹/ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ø§Ù„Ø© ===== */
function collectState(){
  const materials = [...tblBody.querySelectorAll('tr')].map(tr=>({
    name: tr.querySelector('.name').value || '',
    unit: tr.querySelector('.unitSel').value,
    packPrice: parseFloat(tr.querySelector('.packPrice').value)||0,
    packCount: Math.max(0.000001, parseFloat(tr.querySelector('.packCount').value)||0),
    usedCount: Math.max(0, parseFloat(tr.querySelector('.usedCount').value)||0),
  }));
  return {
    materials,
    rent: num('#rent'), labor: num('#labor'), utilities: num('#utilities'), other: num('#other'),
    expectedSales: Math.max(0, parseInt($('#expectedSales').value||'0')),
    cupsMonthly: Math.max(1, parseInt($('#cupsMonthly').value||'1')),
    sellPriceManual: num('#sellPriceManual'),
    targetMargin: num('#targetMargin'),
    vatRate: num('#vatRate'),
    batchQty: Math.max(1, parseInt($('#batchQty').value||'1')),
    batchPriceMode: $('#batchPriceMode').value
  };
}
function populate(state){
  tblBody.innerHTML='';
  (state.materials||[]).forEach(addRow);
  $('#rent').value = state.rent;
  $('#labor').value = state.labor;
  $('#utilities').value = state.utilities;
  $('#other').value = state.other;
  $('#expectedSales').value = state.expectedSales ?? 0;
  $('#cupsMonthly').value = state.cupsMonthly ?? 1;
  $('#sellPriceManual').value = state.sellPriceManual;
  $('#targetMargin').value = state.targetMargin;
  $('#vatRate').value = state.vatRate;
  $('#batchQty').value = state.batchQty;
  $('#batchPriceMode').value = state.batchPriceMode;
  recalc();
}

/* ===== Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© + ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ===== */
function recalc(){
  const st = collectState();

  // 1) ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯
  let materialsTotal = 0;
  [...tblBody.querySelectorAll('tr')].forEach(tr=>{
    const packPrice = parseFloat(tr.querySelector('.packPrice').value)||0;
    const packCount = Math.max(0.000001, parseFloat(tr.querySelector('.packCount').value)||0);
    const usedCount = Math.max(0, parseFloat(tr.querySelector('.usedCount').value)||0);
    const cost = (packPrice/packCount) * usedCount;
    tr.querySelector('.cost').textContent = fmt(cost);
    materialsTotal += cost;
  });
  $('#materialsTotal').textContent = fmt(materialsTotal);

  // 2) Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©
  const fixedTotal = st.rent + st.labor + st.utilities + st.other;
  $('#fixedTotal').textContent = fmt(fixedTotal);

  // 3) Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  const products = loadProducts();
  const totalExpectedAll = products.reduce((sum,p)=>{
    const s = (p && p.state && Number.isFinite(p.state.expectedSales)) ? p.state.expectedSales : 0;
    return sum + Math.max(0, parseInt(s||0));
  }, 0);
  $('#totalExpectedAll').textContent = totalExpectedAll;

  // 4) Ù†ØµÙŠØ¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ + Ù†ØµÙŠØ¨ Ø§Ù„ÙƒÙˆØ¨
  let fixedShareForProduct = 0;
  let fixedPerCup = 0;

  if(totalExpectedAll > 0){
    fixedShareForProduct = fixedTotal * ((st.expectedSales || 0) / totalExpectedAll);
    fixedPerCup = (st.expectedSales>0) ? (fixedShareForProduct / st.expectedSales) : 0;
  }else{
    fixedShareForProduct = fixedTotal;
    fixedPerCup = fixedTotal / Math.max(1, st.cupsMonthly);
  }

  $('#fixedShareForProduct').textContent = fmt(fixedShareForProduct);
  $('#fixedPerCup').textContent = fmt(fixedPerCup);

  // 5) Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„ÙƒÙˆØ¨
  const realCost = materialsTotal + fixedPerCup;
  $('#realCost').textContent = fmt(realCost);

  // 6) Ø±Ø¨Ø­/Ù‡Ø§Ù…Ø´ ÙŠØ¯ÙˆÙŠ
  const profitManual = st.sellPriceManual - realCost;
  $('#profitManual').textContent = fmt(profitManual);
  const marginManual = st.sellPriceManual>0 ? (profitManual / st.sellPriceManual)*100 : 0;
  $('#marginManual').textContent = `${fmt(marginManual)}%`;
  const pill = document.getElementById('pillMargin');
  pill.classList.remove('success','danger');
  if(marginManual>=30) pill.classList.add('success'); else if(marginManual<10) pill.classList.add('danger');

  // 7) Ø³Ø¹Ø± Ù…Ù‚ØªØ±Ø­ + Ø¶Ø±ÙŠØ¨Ø©
  const suggestedPrice = (1 - st.targetMargin/100) <= 0 ? 0 : realCost / (1 - st.targetMargin/100);
  $('#suggestedPrice').textContent = fmt(suggestedPrice);
  const vatPerCup = suggestedPrice * (st.vatRate/100);
  const suggestedAfterVat = suggestedPrice + vatPerCup;
  $('#vatPerCup').textContent = fmt(vatPerCup);
  $('#suggestedAfterVat').textContent = fmt(suggestedAfterVat);

  // 8) Ø¯ÙØ¹Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬
  const batchPrice = (st.batchPriceMode==='manual') ? st.sellPriceManual : suggestedAfterVat;
  const batchCost = realCost * st.batchQty;
  const batchRevenue = batchPrice * st.batchQty;
  const batchProfit = batchRevenue - batchCost;
  $('#batchCost').textContent = fmt(batchCost);
  $('#batchRevenue').textContent = fmt(batchRevenue);
  $('#batchProfit').textContent = fmt(batchProfit);

  // 9) Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙ‚Ø·
  const breakevenCups = (profitManual>0) ? Math.ceil((fixedShareForProduct) / profitManual) : 0;
  $('#breakevenCups') && ($('#breakevenCups').textContent = breakevenCups);

  // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ø§Ù„ÙŠ + ØªØ­Ø¯ÙŠØª ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ
  setCurrentProductState(st);
  renderSummary();
}

/* ===== ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ ===== */
function renderSummary(){
  const body = $('#summaryBody');
  if(!body) return;
  body.innerHTML = '';

  const cur = getCurrentProduct();
  if(!cur) return;

  // Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ø§Ù„ÙŠ
  const fixedTotal = (cur.state.rent||0) + (cur.state.labor||0) + (cur.state.utilities||0) + (cur.state.other||0);

  const list = loadProducts();
  const totalExpectedAll = list.reduce((s,p)=> s + Math.max(0, parseInt((p.state?.expectedSales)||0)), 0) || 0;

  let sumShare = 0;
  list.forEach(p=>{
    const exp = Math.max(0, parseInt((p.state?.expectedSales)||0));
    const share = (totalExpectedAll>0) ? (fixedTotal * (exp/totalExpectedAll)) : 0;
    const pct = (fixedTotal>0) ? (share / fixedTotal * 100) : 0;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</td>
      <td>${exp}</td>
      <td>${fmt(share)}</td>
      <td>${fmt(pct)}%</td>
    `;
    body.appendChild(tr);
    sumShare += share;
  });

  $('#sumExp').textContent = totalExpectedAll;
  $('#sumShare').textContent = fmt(sumShare);
}
$('#btnRefreshSummary')?.addEventListener('click', renderSummary);
$('#btnSummary')?.addEventListener('click', ()=>{ document.getElementById('summary').scrollIntoView({behavior:'smooth'}); });

/* ===== Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù†ØªØ¬ ===== */
function printCurrentProduct(){
  const p = getCurrentProduct(); if(!p) return;
  const st = p.state;

  // Ø§Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
  const materials = st.materials || [];
  const materialsTotal = materials.reduce((sum,m)=>{
    const packPrice = +m.packPrice||0, packCount = Math.max(0.000001, +m.packCount||0), used = +m.usedCount||0;
    return sum + (packPrice/packCount)*used;
  },0);
  const fixedTotal = (st.rent||0)+(st.labor||0)+(st.utilities||0)+(st.other||0);
  const totalExpectedAll = loadProducts().reduce((s,pp)=> s + Math.max(0, parseInt((pp.state?.expectedSales)||0)), 0);
  const fixedShareForProduct = (totalExpectedAll>0) ? fixedTotal*((st.expectedSales||0)/totalExpectedAll) : fixedTotal;
  const fixedPerCup = (st.expectedSales>0 && totalExpectedAll>0) ? (fixedShareForProduct/st.expectedSales) : (fixedTotal/Math.max(1, st.cupsMonthly||1));
  const realCost = materialsTotal + fixedPerCup;
  const profitManual = (st.sellPriceManual||0) - realCost;
  const marginManual = (st.sellPriceManual>0) ? (profitManual/st.sellPriceManual*100) : 0;
  const suggestedPrice = (1 - (st.targetMargin||0)/100) <= 0 ? 0 : realCost/(1-(st.targetMargin||0)/100);
  const vatPerCup = suggestedPrice * ((st.vatRate||0)/100);
  const suggestedAfterVat = suggestedPrice + vatPerCup;

  const win = window.open('', '_blank', 'width=900,height=700');
  win.document.write(`
    <html lang="ar" dir="rtl">
    <head>
      <meta charset="utf-8" />
      <title>Ø·Ø¨Ø§Ø¹Ø© â€” ${p.name||'Ù…Ù†ØªØ¬'}</title>
      <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:24px;line-height:1.6}
        h1,h2{margin:0 0 10px}
        table{width:100%;border-collapse:collapse;margin:12px 0}
        th,td{border:1px solid #ccc;padding:8px;text-align:center}
        th{background:#f4f4f4}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      </style>
    </head>
    <body>
      <h1>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬: ${p.name||'Ù…Ù†ØªØ¬'}</h1>
      <div class="grid">
        <div><b>Ù…Ø¨ÙŠØ¹Ø§Øª Ù…ØªÙˆÙ‚Ø¹Ø©:</b> ${st.expectedSales||0}</div>
        <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ù…Ø±Ø¬Ø¹):</b> ${fixedTotal.toFixed(2)}</div>
        <div><b>Ù†ØµÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ:</b> ${fixedShareForProduct.toFixed(2)}</div>
        <div><b>Ù†ØµÙŠØ¨ Ø§Ù„ÙƒÙˆØ¨ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ:</b> ${fixedPerCup.toFixed(2)}</div>
      </div>

      <h2>Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</h2>
      <table>
        <thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø¯Ø©</th><th>ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø´Ø¯Ø©</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th></tr></thead>
        <tbody>
          ${materials.map(m=>{
            const unitCost = (+m.packPrice||0)/Math.max(0.000001,(+m.packCount||0));
            const cost = unitCost*(+m.usedCount||0);
            const unit = m.unit==='g'?'Ø¬Ù…':(m.unit==='ml'?'Ù…Ù„':'Ø­Ø¨Ø©');
            return `<tr>
              <td>${m.name||''}</td>
              <td>${unit}</td>
              <td>${(+m.packPrice||0).toFixed(2)}</td>
              <td>${(+m.packCount||0).toFixed(2)}</td>
              <td>${(+m.usedCount||0).toFixed(2)}</td>
              <td>${cost.toFixed(2)}</td>
            </tr>`;
          }).join('')}
        </tbody>
        <tfoot><tr><td colspan="5"><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯</b></td><td><b>${materialsTotal.toFixed(2)}</b></td></tr></tfoot>
      </table>

      <h2>Ø§Ù„ØªØ³Ø¹ÙŠØ± ÙˆØ§Ù„Ø±Ø¨Ø­ÙŠØ©</h2>
      <div class="grid">
        <div><b>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„ÙƒÙˆØ¨:</b> ${realCost.toFixed(2)}</div>
        <div><b>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (ÙŠØ¯ÙˆÙŠ):</b> ${(st.sellPriceManual||0).toFixed(2)}</div>
        <div><b>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (ÙŠØ¯ÙˆÙŠ):</b> ${profitManual.toFixed(2)}</div>
        <div><b>Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ %:</b> ${marginManual.toFixed(2)}%</div>
        <div><b>Ø³Ø¹Ø± Ù…Ù‚ØªØ±Ø­ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</b> ${suggestedPrice.toFixed(2)}</div>
        <div><b>Ø¶Ø±ÙŠØ¨Ø© Ù„ÙƒÙ„ ÙƒÙˆØ¨:</b> ${vatPerCup.toFixed(2)}</div>
        <div><b>Ø³Ø¹Ø± Ù…Ù‚ØªØ±Ø­ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</b> ${suggestedAfterVat.toFixed(2)}</div>
      </div>

      <script>window.onload=()=>window.print()</script>
    </body>
    </html>
  `);
  win.document.close();
}
$('#btnPrint')?.addEventListener('click', printCurrentProduct);

/* ===== ÙˆØ§Ø¬Ù‡Ø© CRUD Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ===== */
function renderProductSelectAndLoad(){
  renderProductSelect();
  const cur = getCurrentProduct();
  populate(cur ? cur.state : JSON.parse(JSON.stringify(defaultState)));
}
$('#productSelect').addEventListener('change', ()=>{
  setCurrentId($('#productSelect').value);
  const p = getCurrentProduct(); if(p) populate(p.state);
});
$('#btnNew').addEventListener('click', ()=>{
  const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŸ','Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯'); if(!name) return;
  const id = uid();
  const list = loadProducts();
  list.push({id, name, state: JSON.parse(JSON.stringify(defaultState))});
  saveProducts(list); setCurrentId(id); renderProductSelectAndLoad();
});
$('#btnRename').addEventListener('click', ()=>{
  const p = getCurrentProduct(); if(!p) return;
  const name = prompt('Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ù†ØªØ¬:', p.name); if(!name) return;
  const list = loadProducts().map(x=> x.id===p.id ? ({...x, name}) : x);
  saveProducts(list); renderProductSelect();
});
$('#btnDelete').addEventListener('click', ()=>{
  const p = getCurrentProduct(); if(!p) return;
  if(!confirm(`Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ "${p.name}"ØŸ`)) return;
  let list = loadProducts().filter(x=> x.id!==p.id);
  if(list.length===0){
    const id = uid();
    list = [{id, name:'Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯', state: JSON.parse(JSON.stringify(defaultState))}];
    setCurrentId(id);
  }else{
    setCurrentId(list[0].id);
  }
  saveProducts(list); renderProductSelectAndLoad();
});
$('#btnSave').addEventListener('click', ()=>{
  setCurrentProductState(collectState());
  notify('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
});
$('#btnSaveAs').addEventListener('click', ()=>{
  const name = prompt('Ø­ÙØ¸ Ø¨Ø§Ø³Ù…ØŸ','Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø©'); if(!name) return;
  const state = collectState();
  const id = uid();
  const list = loadProducts();
  list.push({id, name, state});
  saveProducts(list); setCurrentId(id); renderProductSelectAndLoad();
  notify('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø© âœ…');
});

/* ===== Ø¥Ø´Ø¹Ø§Ø± ØµØºÙŠØ± ===== */
function notify(txt){
  const b = document.createElement('div');
  b.textContent = txt;
  b.style.cssText = 'position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111;border:1px solid #2d3136;padding:8px 12px;border-radius:10px;z-index:9999';
  document.body.appendChild(b);
  setTimeout(()=>b.remove(),1200);
}

/* ===== ØªÙ‡ÙŠØ¦Ø© ===== */
function init(){
  renderProductSelectAndLoad();
  document.addEventListener('input', (e)=>{ if(e.target.matches('input, select')) recalc(); });
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id==='addRowBtn'){
      const row = {name:'Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©',unit:'piece',packPrice:0,packCount:1,usedCount:0};
      tblBody.appendChild(makeRow(row));
      recalc();
    }
  });
  $('#resetBtn').addEventListener('click', ()=>{
    if(confirm('Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')){
      const st = JSON.parse(JSON.stringify(defaultState));
      populate(st);
      setCurrentProductState(st);
    }
  });
}
init();
</script>
</body>
</html>
